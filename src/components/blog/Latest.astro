---
// src/components/blog/Latest.astro
import { fetchStrapiArticles } from '@libs/strapi';
import { normalizeArticle } from '@/src/types/strapi';

const POSTS_TO_SHOW = 3;

const allArticles = await fetchStrapiArticles();

const sortedArticles = allArticles.sort((a, b) => {
  const dateA = a.originalPublishedAt ? new Date(a.originalPublishedAt).getTime() : 0;
  const dateB = b.originalPublishedAt ? new Date(b.originalPublishedAt).getTime() : 0;
  return dateB - dateA;
});

const latestPosts = sortedArticles.slice(0, POSTS_TO_SHOW).map(normalizeArticle);
---

<div class="latest-blog">
  <div class="latest-blog--header">
    <h2 class="datum-text-8xl mb-6">Latest from the blog</h2>
    <a href="/blog/" class="latest-blog--link">
      View all posts <span aria-hidden="true">&rarr;</span>
    </a>
  </div>

  <div class="latest-blog--grid">
    {
      latestPosts.map((post) => (
        <a href={`/blog/${post.id}/`} class="latest-blog--item">
          {post.data.thumbnail && (
            <div class="latest-blog--thumbnail">
              <img
                src={post.data.thumbnail}
                alt={post.data.title}
                class="latest-blog--image"
                width={400}
                height={225}
                loading="lazy"
              />
            </div>
          )}
          <div class="latest-blog--content">
            <h3 class="latest-blog--title">{post.data.title}</h3>
            {post.data.description && (
              <p class="latest-blog--description">{post.data.description}</p>
            )}
            <time class="latest-blog--date" datetime={post.data.date.toISOString()}>
              {post.data.date.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
              })}
            </time>
          </div>
        </a>
      ))
    }
  </div>
</div>
