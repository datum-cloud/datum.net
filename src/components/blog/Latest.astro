---
// src/components/blog/Latest.astro
import { fetchStrapiArticles } from '@libs/strapi';
import { normalizeArticle } from '@/src/types/strapi';

const POSTS_TO_SHOW = 3;

const allArticles = await fetchStrapiArticles();

const sortedArticles = allArticles.sort((a, b) => {
  const dateA = a.originalPublishedAt ? new Date(a.originalPublishedAt).getTime() : 0;
  const dateB = b.originalPublishedAt ? new Date(b.originalPublishedAt).getTime() : 0;
  return dateB - dateA;
});

const latestPosts = sortedArticles.slice(0, POSTS_TO_SHOW).map(normalizeArticle);
---

<h2
  class="datum-text-xl border-midnight-fjord m-0 mb-8 w-full border-b pb-6 md:mb-12 md:pb-8 lg:mb-16"
>
  Latest thoughts from the team
</h2>

{
  latestPosts.length > 0 ? (
    <div class="grid grid-cols-4 gap-8 md:grid-cols-11 lg:gap-11">
      {latestPosts[0] && (
        <div class="col-span-4 flex flex-1 flex-col md:col-span-5 lg:col-span-6">
          {latestPosts[0].data.thumbnail && (
            <a
              href={`/blog/${latestPosts[0].id}/`}
              title={latestPosts[0].data.title}
              class="mb-6 w-full"
            >
              <img
                src={latestPosts[0].data.thumbnail}
                alt={latestPosts[0].data.title}
                class="block h-auto w-full rounded-[4px] object-cover transition-opacity duration-200 hover:opacity-90"
                width={1440}
                height={810}
                loading="lazy"
              />
            </a>
          )}
          <h3 class="datum-text-2xl mb-3 font-medium">
            <a
              href={`/blog/${latestPosts[0].id}/`}
              title={latestPosts[0].data.title}
              class="transition-opacity duration-200 hover:opacity-70"
            >
              {latestPosts[0].data.title}
            </a>
          </h3>
          {latestPosts[0].data.description && (
            <p class="datum-text-base mb-3 text-pretty opacity-80">
              {latestPosts[0].data.description}
            </p>
          )}
          <time datetime={latestPosts[0].data.date.toISOString()} class="datum-text-sm opacity-40">
            {latestPosts[0].data.date.toLocaleDateString('en-US', {
              day: 'numeric',
              month: 'short',
              year: 'numeric',
            })}
          </time>
        </div>
      )}

      <div class="col-span-4 flex gap-6 md:col-span-6 md:gap-8 lg:col-span-5 lg:gap-11">
        {latestPosts.slice(1).map((post) => (
          <div class="flex flex-1 flex-col">
            {post.data.thumbnail && (
              <a href={`/blog/${post.id}/`} title={post.data.title} class="mb-6 w-full">
                <img
                  src={post.data.thumbnail}
                  alt={post.data.title}
                  class="block h-auto w-full rounded-[4px] object-cover transition-opacity duration-200 hover:opacity-90"
                  width={800}
                  height={450}
                  loading="lazy"
                />
              </a>
            )}
            <h4 class="datum-text-xl mb-3 font-medium">
              <a
                href={`/blog/${post.id}/`}
                title={post.data.title}
                class="transition-opacity duration-200 hover:opacity-70"
              >
                {post.data.title}
              </a>
            </h4>
            {post.data.description && (
              <p class="datum-text-sm mb-3 text-pretty opacity-80">{post.data.description}</p>
            )}
            <time datetime={post.data.date.toISOString()} class="datum-text-sm opacity-40">
              {post.data.date.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
              })}
            </time>
          </div>
        ))}
      </div>
    </div>
  ) : null
}
