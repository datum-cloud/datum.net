---
// src/components/forms/NewsletterModal.astro
// Popup modal for newsletter signup â€” form layout from Figma (node 9185-41852).
import Icon from '@components/Icon.astro';
---

<style>
  .animated-check,
  .animated-error {
    animation: scale-in 0.3s ease-out;
  }

  .check-circle,
  .error-circle {
    stroke-dasharray: 138;
    stroke-dashoffset: 138;
    animation: draw-circle 0.6s ease-out forwards;
  }

  .check-mark {
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: draw-check 0.4s ease-out 0.3s forwards;
  }

  .error-x {
    stroke-dasharray: 40;
    stroke-dashoffset: 40;
    animation: draw-check 0.4s ease-out 0.3s forwards;
  }

  @keyframes scale-in {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    50% {
      transform: scale(1.1);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes draw-circle {
    to {
      stroke-dashoffset: 0;
    }
  }

  @keyframes draw-check {
    to {
      stroke-dashoffset: 0;
    }
  }
</style>

<newsletter-modal>
  <dialog aria-label="Subscribe for monthly updates">
    <div class="modal-frame newsletter-modal-frame">
      <button data-close-modal class="modal-close" aria-label="Close" type="button">
        <Icon name="close" size="sm" class="modal-close-icon" />
      </button>
      <div class="newsletter-modal-content">
        <div class="newsletter-modal-success hidden items-center gap-3 text-nowrap">
          <svg
            class="animated-check text-green-600"
            width="48"
            height="48"
            viewBox="0 0 48 48"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle
              class="check-circle"
              cx="24"
              cy="24"
              r="22"
              stroke="currentColor"
              stroke-width="2"
              fill="none"></circle>
            <path
              class="check-mark"
              d="M14 24l8 8 16-16"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
              fill="none"></path>
          </svg>
          <svg
            class="animated-error hidden text-red-600"
            width="48"
            height="48"
            viewBox="0 0 48 48"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle
              class="error-circle"
              cx="24"
              cy="24"
              r="22"
              stroke="currentColor"
              stroke-width="2"
              fill="none"></circle>
            <path
              class="error-x"
              d="M16 16l16 16M32 16l-16 16"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              fill="none"></path>
          </svg>
          <span id="message" class="datum-text-lg">You're on the list</span>
        </div>

        <div class="newsletter-modal-form-container">
          <div class="flex flex-col gap-6 text-center">
            <h3 class="datum-text-7xl font-canela text-midnight-fjord mb-0 text-center font-normal">
              Subscribe for monthly updates
            </h3>
            <p class="datum-text-base text-midnight-fjord/80 mb-0">
              No spam, no marketing fluff, we promise
            </p>
          </div>

          <form class="newsletter-modal-form" onsubmit="return false;">
            <div class="newsletter-modal-fields">
              <label class="newsletter-modal-field">
                <span class="newsletter-modal-label">First name</span>
                <input
                  type="text"
                  name="givenName"
                  placeholder="e.g. Jane"
                  class="newsletter-modal-input"
                  autocomplete="given-name"
                />
              </label>
              <label class="newsletter-modal-field">
                <span class="newsletter-modal-label">Last name</span>
                <input
                  type="text"
                  name="familyName"
                  placeholder="e.g. Smith"
                  class="newsletter-modal-input"
                  autocomplete="family-name"
                />
              </label>
              <label class="newsletter-modal-field">
                <span class="newsletter-modal-label">Email address</span>
                <input
                  type="email"
                  name="email"
                  placeholder="jane@example.com"
                  class="newsletter-modal-input"
                  autocomplete="email"
                  required
                />
              </label>
            </div>

            <div class="newsletter-modal-consent">
              <input
                type="checkbox"
                name="consent"
                id="newsletter-modal-consent"
                class="newsletter-modal-checkbox"
                required
              />
              <label
                for="newsletter-modal-consent"
                class="datum-app-body text-midnight-fjord/80 cursor-pointer"
              >
                I agree to receive updates and news from Datum. See our
                <a
                  href="/legal/privacy/"
                  class="text-canyon-clay---links underline hover:no-underline"
                  target="_blank"
                  tabindex="0">Privacy Policy</a
                >
              </label>
            </div>

            <div class="newsletter-modal-actions">
              <button
                type="submit"
                class="btn btn--pine-forge disabled:cursor-not-allowed disabled:opacity-50"
                aria-label="Subscribe"
                disabled
              >
                <span id="submit-btn-text">Subscribe</span>
                <Icon name="arrow-right" size="sm" />
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </dialog>
</newsletter-modal>

<script>
  import { actions } from 'astro:actions';
  const NEWSLETTER_MODAL_OPEN_EVENT = 'newsletter-modal-open';
  const NEWSLETTER_MODAL_CLOSE_EVENT = 'newsletter-modal-close';

  declare global {
    interface Window {
      NEWSLETTER_MODAL_OPEN_EVENT: string;
      NEWSLETTER_MODAL_CLOSE_EVENT: string;
    }
    interface CustomEventMap {
      'newsletter-modal-open': CustomEvent;
      'newsletter-modal-close': CustomEvent;
    }
  }

  const NEWSLETTER_MODAL_HASH = '#newsletter-modal';

  class NewsletterModal extends HTMLElement {
    dialog: HTMLDialogElement;
    dialogFrame: HTMLElement;
    closeBtn: HTMLButtonElement;
    form: HTMLFormElement;
    consentCheckbox: HTMLInputElement;
    submitBtn: HTMLButtonElement;
    submitBtnText: HTMLElement;
    successMessage: HTMLElement;
    formContainer: HTMLElement;
    dialogOpenedAt = 0;
    isSubmitting = false;

    constructor() {
      super();
      this.dialog = this.querySelector('dialog')!;
      this.dialogFrame = this.querySelector('.modal-frame')!;
      this.closeBtn = this.querySelector<HTMLButtonElement>('button[data-close-modal]')!;
      this.form = this.querySelector('.newsletter-modal-form')!;
      this.consentCheckbox = this.querySelector<HTMLInputElement>('#newsletter-modal-consent')!;
      this.submitBtn = this.querySelector<HTMLButtonElement>('button[type="submit"]')!;
      this.submitBtnText = this.querySelector<HTMLElement>('#submit-btn-text')!;
      this.successMessage = this.querySelector('.newsletter-modal-success')!;
      this.formContainer = this.querySelector('.newsletter-modal-form-container')!;
      this.setupEventListeners();
    }

    connectedCallback() {
      if (window.location.hash === NEWSLETTER_MODAL_HASH) {
        requestAnimationFrame(() => this.openModal());
      }
    }

    setupEventListeners() {
      document.addEventListener(NEWSLETTER_MODAL_OPEN_EVENT, () => this.openModal());
      this.closeBtn.addEventListener('click', () => this.closeModal());
      window.addEventListener('popstate', () => {
        if (this.dialog.open && window.location.hash !== NEWSLETTER_MODAL_HASH) this.closeModal();
      });

      this.dialog.addEventListener('close', () => {
        document.body.toggleAttribute('data-newsletter-modal-open', false);
        window.removeEventListener('click', this.onClick);
        if (window.location.hash === NEWSLETTER_MODAL_HASH) {
          history.replaceState(null, '', window.location.pathname + window.location.search);
        }
        document.dispatchEvent(new CustomEvent(NEWSLETTER_MODAL_CLOSE_EVENT));
      });

      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.dialog.open) {
          this.closeModal();
          e.preventDefault();
        }
      });

      this.consentCheckbox.addEventListener('change', () => {
        this.submitBtn.disabled = !this.consentCheckbox.checked;
      });

      this.form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!this.isSubmitting) {
          this.submitForm();
        }
      });
    }

    submitForm() {
      // Set loading state
      this.isSubmitting = true;
      this.submitBtn.disabled = true;
      this.submitBtnText.textContent = 'Please wait';

      actions
        .NewsletterSignup({
          email: this.form.email.value,
          givenName: this.form.givenName.value,
          familyName: this.form.familyName.value,
        })
        .then((result) => {
          if (!result.data || result.data != 200) {
            if (result.data == 422) {
              this.showSuccessMessage("Looks like you're already subscribed!", false);
            } else {
              this.showSuccessMessage(
                'Something went wrong. Please try again in a minute or two.',
                false
              );
            }
          } else {
            this.showSuccessMessage("You're on the list");
          }
        })
        .catch(() => {
          this.showSuccessMessage(
            'Something went wrong. Please try again in a minute or two.',
            false
          );
        })
        .finally(() => {
          // Reset loading state
          this.isSubmitting = false;
          this.submitBtnText.textContent = 'Subscribe';
          this.submitBtn.disabled = !this.consentCheckbox.checked;
        });
    }

    showSuccessMessage(message: string, success: boolean = true) {
      this.formContainer.classList.add('hidden');
      this.successMessage.querySelector('#message')!.textContent = message;
      this.successMessage.classList.remove('hidden');
      this.successMessage.classList.add('flex');

      // Show/hide appropriate icon
      const checkSvg = this.successMessage.querySelector('.animated-check');
      const errorSvg = this.successMessage.querySelector('.animated-error');

      if (success) {
        errorSvg?.classList.add('hidden');
        checkSvg?.classList.remove('hidden');
        // Restart animation by cloning the SVG
        if (checkSvg) {
          const clone = checkSvg.cloneNode(true);
          checkSvg.parentNode?.replaceChild(clone, checkSvg);
        }
      } else {
        checkSvg?.classList.add('hidden');
        errorSvg?.classList.remove('hidden');
        // Restart animation by cloning the SVG
        if (errorSvg) {
          const clone = errorSvg.cloneNode(true);
          errorSvg.parentNode?.replaceChild(clone, errorSvg);
        }
      }

      setTimeout(() => {
        this.closeModal();
      }, 3000);
    }

    onClick = (event: MouseEvent) => {
      const target = event.target as HTMLElement;
      const isInDialog = target.closest('dialog') !== null;
      const isInDialogFrame = target.closest('.modal-frame') !== null;
      const isDialogBackdropClick = isInDialog && !isInDialogFrame;
      const timeSinceOpen = Date.now() - this.dialogOpenedAt;
      if (isDialogBackdropClick || (timeSinceOpen >= 300 && !this.dialogFrame.contains(target))) {
        this.closeModal();
      }
    };

    openModal() {
      this.form.reset();
      this.formContainer.classList.remove('hidden');
      this.successMessage.classList.add('hidden');
      this.successMessage.classList.remove('flex');
      this.dialog.showModal();
      document.body.toggleAttribute('data-newsletter-modal-open', true);
      this.dialogOpenedAt = Date.now();
      if (window.location.hash !== NEWSLETTER_MODAL_HASH) {
        history.replaceState(
          null,
          '',
          window.location.pathname + window.location.search + NEWSLETTER_MODAL_HASH
        );
      }
      setTimeout(() => window.addEventListener('click', this.onClick), 100);
    }

    closeModal() {
      this.dialog.close();
    }
  }

  customElements.define('newsletter-modal', NewsletterModal);
  window.NEWSLETTER_MODAL_OPEN_EVENT = NEWSLETTER_MODAL_OPEN_EVENT;
  window.NEWSLETTER_MODAL_CLOSE_EVENT = NEWSLETTER_MODAL_CLOSE_EVENT;
</script>
