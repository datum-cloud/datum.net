---
import { getCollection, render } from 'astro:content';
import Sidebar from '@components/handbook/Sidebar.astro';
import PageNav from '@components/handbook/PageNav.astro';
import type { ArticleProps } from '@/src/types/common';

const {
  articleId: propArticleId,
  showSidebar = true,
  class: className,
} = Astro.props as ArticleProps;

// Support both prop-based and URL parameter-based article loading
const urlParam = Astro.url.searchParams.get('article');
const articleId = propArticleId || urlParam || 'company/why-we-exist';

const handbooks = await getCollection('handbooks', ({ id }) => id !== 'index');

// Get the specified article for main content display
const mainArticleEntry =
  handbooks.find((h) => h.id === articleId) ||
  handbooks.find((h) => h.id === 'company/why-we-exist');

// Render the article content
const mainArticle = mainArticleEntry ? await render(mainArticleEntry) : null;
---

<section
  class:list={[
    'handbook-article bg-pearl-gray section--block section--block--pad section--block--small-pad',
    className,
  ]}
>
  <div class:list={['handbook-container', !showSidebar && 'handbook-container--no-sidebar']}>
    {showSidebar && <Sidebar currentArticleId={articleId} handbooks={handbooks} />}

    {/* Main Content Area */}
    <article class="handbook-content">
      <header class="article-header">
        <h1 class="article-title">
          {mainArticleEntry?.data.title || 'Why does Datum exist?'}
        </h1>
      </header>

      <div class="article-body">
        {
          mainArticle?.Content ? (
            <mainArticle.Content />
          ) : (
            <div class="article-paragraph">
              <p>
                No content found for article ID: <strong>{articleId}</strong>
              </p>
              {mainArticleEntry ? (
                <p>Article entry found but content failed to render.</p>
              ) : (
                <p>
                  Article entry not found. Available articles:{' '}
                  {handbooks.map((h) => h.id).join(', ')}
                </p>
              )}
            </div>
          )
        }
      </div>

      {/* Navigation */}
      <PageNav currentArticleId={articleId} />
    </article>
  </div>
</section>
