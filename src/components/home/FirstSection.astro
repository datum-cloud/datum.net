---
import { Image } from 'astro:assets';
import { marked } from 'marked';
import Video from '@components/home/Video.astro';
import asideNote from '@v1/assets/images/aside-note.png';
import type { ContentProps } from '@/src/types/common';

const { content } = Astro.props as ContentProps;

// Create 7 columns and distribute logos as evenly as possible across them
const logoColumns = [];
if (content.data.images) {
  const images = content.data.images;
  const totalLogos = images.length;
  const columnsCount = 7;

  const minPerColumn = Math.floor(totalLogos / columnsCount);
  const extra = totalLogos % columnsCount;

  let currentIndex = 0;

  for (let i = 0; i < columnsCount; i++) {
    const columnSize = minPerColumn + (i < extra ? 1 : 0);
    const columnLogos = [];

    for (let j = 0; j < columnSize; j++) {
      const logoIndex = currentIndex++;
      const logo = images[logoIndex];
      if (!logo) break;

      columnLogos.push({
        src: logo.img,
        alt: logo.alt || `Partner logo ${logoIndex + 1}`,
        index: logoIndex,
      });
    }

    logoColumns.push({
      logos: columnLogos,
      delay: i * 1, // Stagger each column
    });
  }
}
---

<section
  id="why-evolve"
  class="bg-glacier-mist-700 section--block section--block--pad fade-in--pure overflow-clip"
  data-reveal="fade-in--pure--visible"
  data-reveal-immediate="true"
>
  <div class="max-width relative">
    <div class="relative z-10 flex flex-col">
      <div
        class="mb-10 grid grid-cols-1 items-center gap-10 md:mb-14 md:grid-cols-2 md:gap-20 lg:mb-18 lg:gap-35 xl:mb-22.5"
      >
        <div class="w-full max-w-146.75 text-center md:text-left">
          <div
            class="text-(length:--text-2xl-font-size) text-balance [&>p]:leading-[142%] [&>p]:tracking-normal"
            set:html={marked.parse(content.body)}
          />
        </div>

        <div class="w-full grow">
          <Video />
        </div>
      </div>

      <div class="datum-text-sm mb-5.5 block w-full text-balance md:whitespace-nowrap">
        We're on a mission to help 1k new clouds, like these
      </div>

      <div class="relative">
        <Image
          src={asideNote}
          layout="constrained"
          alt="Not actual clients yet"
          class="absolute -top-5 -right-3 z-15 size-auto w-full max-w-35.5 md:-right-5 md:max-w-45.5 lg:-top-8 lg:max-w-55.5"
        />

        <!-- Logos Row -->
        {
          content.data.images ? (
            <div class="rounded-md border border-(--app---dark---utility-5)">
              <div class="grid grid-cols-4 overflow-x-auto md:grid-cols-7">
                {logoColumns.map((column, columnIndex) => (
                  <div class="flex aspect-4/3 items-center justify-center">
                    <div
                      class="logo-cycling-container relative flex h-full w-full items-center justify-center px-5"
                      data-column-index={columnIndex}
                    >
                      {column.logos.map((logo, logoIndex) => (
                        <Image
                          src={logo.src}
                          alt={logo.alt}
                          loading="lazy"
                          class={`logo-cycle absolute max-h-9 w-full max-w-18 object-contain md:max-w-22 lg:max-w-27 ${logoIndex === 0 ? 'opacity-100' : 'opacity-0'}`}
                          data-logo-index={logo.index}
                          data-column-logo-index={logoIndex}
                        />
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            ''
          )
        }
      </div>
    </div>
  </div>
</section>

<style>
  .logo-cycle {
    transition: opacity 1s ease-in-out;
  }
</style>

<script>
  // Logo cycling functionality
  document.addEventListener('DOMContentLoaded', () => {
    const containers = document.querySelectorAll('.logo-cycling-container');

    containers.forEach((container) => {
      const columnIndex = parseInt(container.getAttribute('data-column-index') || '0');
      const logos = container.querySelectorAll('.logo-cycle');
      const totalLogos = logos.length;
      let currentIndex = 0;

      // Set initial logo
      logos.forEach((logo, index) => {
        if (index === currentIndex) {
          logo.classList.remove('opacity-0');
          logo.classList.add('opacity-100');
        } else {
          logo.classList.remove('opacity-100');
          logo.classList.add('opacity-0');
        }
      });

      // Cycle through logos with fade transition
      const cycleLogos = () => {
        // Hide current logo with fade out
        logos[currentIndex].classList.remove('opacity-100');
        logos[currentIndex].classList.add('opacity-0');

        // Move to next logo
        currentIndex = (currentIndex + 1) % totalLogos;

        // Show next logo with fade in after a longer delay
        setTimeout(() => {
          logos[currentIndex].classList.remove('opacity-0');
          logos[currentIndex].classList.add('opacity-100');
        }, 800); // Longer delay for smoother transition with slower fade
      };

      // Start cycling with staggered timing for each column
      const baseDelay = 8000; // 5 seconds cycle for longer pause between logo changes
      const columnDelay = columnIndex * 1000; // Increased stagger delay

      // Start the first cycle immediately (with column delay), then repeat every 5s
      setTimeout(() => {
        cycleLogos();
        setInterval(cycleLogos, baseDelay);
      }, columnDelay);
    });
  });
</script>
