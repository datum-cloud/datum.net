---
// Overwrite @astrojs/starlight/components/Head.astro
import Favicons from '@components/Favicons.astro';
import defaultOgImage from '@content/images/og/default.png';

const { head } = Astro.locals.starlightRoute;
const { entry } = Astro.locals.starlightRoute;

// SEO
const fm = entry.data;
const meta = fm.meta || {};
const title = meta.title ?? fm.title;
const description = meta.description ?? fm.description;

// Default OG image for docs
const ogImage = meta && meta.og && meta.og.image ? meta.og.image : defaultOgImage;

// Check if og:image and twitter:image exist in head
const hasOgImage = head.some(
  ({ tag, attrs }) => tag === 'meta' && attrs && attrs.property === 'og:image'
);
const hasTwitterImage = head.some(
  ({ tag, attrs }) => tag === 'meta' && attrs && attrs.name === 'twitter:image'
);
---

{
  head.map(({ tag: Tag, attrs, content }) => {
    if (title && Tag === 'title') {
      return <Tag>{title}</Tag>;
    }

    if (description && Tag === 'meta' && attrs && attrs.name === 'description') {
      return <Tag {...attrs} content={description} />;
    }

    if (meta.og && meta.og.title && Tag === 'meta' && attrs && attrs.property === 'og:title') {
      return <Tag {...attrs} content={meta.og.title} />;
    }

    if (
      meta.og &&
      meta.og.description &&
      Tag === 'meta' &&
      attrs &&
      attrs.property === 'og:description'
    ) {
      return <Tag {...attrs} content={meta.og.description} />;
    }

    if (Tag === 'meta' && attrs && attrs.property === 'og:image') {
      return <Tag {...attrs} content={ogImage} />;
    }

    if (Tag === 'meta' && attrs && attrs.name === 'twitter:image') {
      return <Tag {...attrs} content={ogImage} />;
    }

    if (meta.og && meta.og.url && Tag === 'meta' && attrs && attrs.property === 'og:url') {
      return <Tag {...attrs} content={meta.og.url} />;
    }

    if (meta.og && meta.og.article && Tag === 'meta' && attrs && attrs.property === 'og:type') {
      return <Tag {...attrs} content="article" />;
    }

    if (meta.og && meta.og.url && Tag === 'meta' && attrs && attrs.property === 'og:url') {
      return <Tag {...attrs} content={meta.og.url} />;
    }

    // Filter out Starlight's default favicon links - we handle favicons in Favicons.astro
    if (Tag === 'link' && attrs && attrs.rel) {
      const relValue = attrs.rel;
      if (
        relValue === 'icon' ||
        relValue === 'shortcut icon' ||
        relValue === 'mask-icon' ||
        relValue === 'apple-touch-icon'
      ) {
        return null;
      }
    }

    return <Tag {...attrs} set:html={content} />;
  })
}

<!-- Favicons -->
<Favicons />

<!-- Add og:logo, og:image and twitter:image if not present in Starlight's head -->
<meta property="og:logo" content={new URL('/images/logo-datum.png', Astro.site).href} />
{!hasOgImage && <meta property="og:image" content={ogImage.src} />}
{!hasTwitterImage && <meta name="twitter:image" content={ogImage.src} />}
