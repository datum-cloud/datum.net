---
import config from 'virtual:starlight/user-config';
import PageSidebar from './PageSidebar.astro';
import { Breadcrumbs } from 'astro-breadcrumbs';
import SearchButton from './SearchButton.astro';
import { getCollection } from 'astro:content';

const { hasSidebar } = Astro.locals.starlightRoute;
const starlightRoute = Astro.locals.starlightRoute;

let breadcrumbData = [];
const fullPath = Astro.url.pathname;

const pathSegments = fullPath
  .replace(/^\/?docs\//, '')
  .replace(/\/$/, '')
  .split('/')
  .filter(Boolean);

breadcrumbData.push(
  {
    text: 'Home',
    href: '/docs/',
  },
  {
    text: 'Docs',
    href: '/docs/',
    class: 'docs-menu-toggle',
  },
  {
    text: 'Docs',
    href: '/docs/',
    class: 'docs-md',
  }
);

const allDocs = await getCollection('docs');

if (pathSegments.length > 0) {
  let currentPath = '';
  let currentSlug = '';
  let lastSegment = pathSegments.at(-1);

  for (const segment of pathSegments) {
    if (segment == 'overview') continue;

    currentPath += '/' + segment;
    currentSlug = currentSlug ? `${currentSlug}/${segment}` : segment;

    const segmentIndexPaths = [
      `docs/${segment}/index`,
      `${segment}/index`,
      `docs/docs/${segment}/index`,
    ];

    const indexFile = allDocs.find(
      (entry) =>
        segmentIndexPaths.includes(entry.id) ||
        entry.id === `docs/${currentSlug}/index` ||
        entry.id === `${currentSlug}/index` ||
        (entry.id.endsWith('/index') && entry.id.split('/').includes(segment))
    );

    if (indexFile) {
      // Replace "Overview" titles with formatted segment name
      const titleText =
        indexFile.data.title === 'Overview'
          ? segment.replace(/-/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase())
          : indexFile.data.title;

      breadcrumbData.push({
        text: titleText,
        href: lastSegment != segment ? '/docs' + currentPath + '/' : null,
      });

      continue;
    }

    let docEntry = allDocs.find((entry) => entry.id === currentSlug);

    if (!docEntry) {
      const indexEntries = allDocs.filter(
        (entry) =>
          entry.id === currentSlug ||
          (entry.id.startsWith(`${currentSlug}/`) && entry.id.split('/').pop() === 'index') ||
          entry.id === `docs/${currentSlug}` ||
          (entry.id.startsWith(`docs/${currentSlug}/`) && entry.id.split('/').pop() === 'index')
      );

      if (indexEntries.length > 0) {
        docEntry = indexEntries.find((entry) => entry.id === currentSlug) || indexEntries[0];
      }
    }

    let segmentTitle;
    if (docEntry && docEntry.data.title) {
      segmentTitle =
        docEntry.data.title === 'Overview'
          ? segment.replace(/-/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase())
          : docEntry.data.title;
    } else {
      segmentTitle = segment.replace(/-/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase());
    }

    breadcrumbData.push({
      text: segmentTitle,
      href: lastSegment != segment ? '/docs' + currentPath + '/' : null,
    });
  }

  // Override last breadcrumb with current page title
  if (starlightRoute.entry?.data?.title) {
    const pageTitle = starlightRoute.entry.data.title;
    if (pageTitle === 'Overview' && lastSegment) {
      breadcrumbData[breadcrumbData.length - 1].text = lastSegment
        .replace(/-/g, ' ')
        .replace(/\b\w/g, (c: string) => c.toUpperCase());
    } else {
      breadcrumbData[breadcrumbData.length - 1].text = pageTitle;
    }
  }
}

const shouldRenderSearch =
  config.pagefind || config.components.Search !== '@astrojs/starlight/components/Search.astro';
---

<div class="sl-content-panel">
  <section class="sl-main-content">
    <div class="searchbar-main-content print:hidden">
      {shouldRenderSearch && <SearchButton class="search-button" />}
    </div>
    <Breadcrumbs
      linkTextFormat="sentence"
      crumbs={breadcrumbData.length > 0 ? breadcrumbData : undefined}
    >
      <svg
        slot="index"
        aria-label="Home Page"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"> </path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    </Breadcrumbs>

    <main data-glossary-body class="sl-content">
      <slot />
    </main>
  </section>

  {
    hasSidebar && (
      <aside class="right-sidebar-container astro-67yu43on print:hidden">
        <div class="right-sidebar astro-67yu43on">
          <PageSidebar />
        </div>
      </aside>
    )
  }
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const breadcrumbs = document.querySelectorAll('li.c-breadcrumbs__crumb');

    if (breadcrumbs.length >= 5) {
      breadcrumbs[breadcrumbs.length - 1].classList.add('hidden', 'md:inline-flex');
    }

    const docsMenuToggle = document.querySelector('.docs-menu-toggle');
    const pathSegments = window.location.pathname
      .replace(/^\/?docs\//, '')
      .replace(/\/$/, '')
      .split('/')
      .filter(Boolean);

    const toggleSidebar = () => {
      if (window.innerWidth < 768) {
        const expanded = document.body.hasAttribute('data-mobile-menu-expanded');

        if (!expanded) {
          document.body.setAttribute('data-mobile-menu-expanded', '');
          document.body.classList.add('mobile-menu-open');
          document.body.style.overflow = 'hidden';
        } else {
          document.body.removeAttribute('data-mobile-menu-expanded');
          document.body.classList.remove('mobile-menu-open');
          document.body.style.overflow = '';
        }
      }
    };

    // Auto-open sidebar on root docs page
    if (pathSegments.length === 0 && window.location.pathname.includes('/docs')) {
      setTimeout(() => toggleSidebar(), 100);
    }

    if (docsMenuToggle) {
      docsMenuToggle.addEventListener('click', (e) => {
        if (window.innerWidth < 768) {
          e.preventDefault();
          toggleSidebar();
        }
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
          document.body.removeAttribute('data-mobile-menu-expanded');
          document.body.classList.remove('mobile-menu-open');
          document.body.style.overflow = '';
        }
      });
    }
  });
</script>
