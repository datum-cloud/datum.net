---
export const prerender = false;
import { dbConnect } from '@libs/postgres';

const mode = process.env.MODE || import.meta.env.MODE;

// only for development mode, to ease testing
if (mode == 'production') {
  return;
}

/**
 * Database testing
 */
let dbConnected = false;
try {
  const sql = await dbConnect();
  const tables = await sql`SHOW TABLES`;
  if (tables) {
    dbConnected = true;
  }
} catch {
  dbConnected = false;
}

type EnvValue = string | number | boolean | undefined;
type EnvRecord = Record<string, EnvValue>;

/**
 * Filters out sensitive environment variables by masking their values.
 * Sensitive variables are identified by common keywords in their names
 * or if their values contain user-specific file paths.
 */
const filterSensitiveVars = (envVars: EnvRecord): EnvRecord => {
  return Object.fromEntries(
    Object.entries(envVars).map(([key, value]) => {
      if (key === '_') return [key, undefined];
      const lowerKey = key.toLowerCase();
      // Check for common sensitive variable patterns in keys
      const sensitiveKeyPatterns = [
        'key',
        'secret',
        'password',
        'token',
        'auth',
        'credential',
        'private',
        'user',
        'home',
        'dir',
        'path',
        'id',
        'login',
        'pwd',
        'logname',
        'shell',
        'pass',
        'cwd',
        'npm',
      ];

      // Check if any sensitive pattern exists in the key
      const hasSensitivePattern = sensitiveKeyPatterns.some((pattern) =>
        lowerKey.includes(pattern)
      );

      // Check if value contains file paths with usernames
      const isValueWithUserPath =
        typeof value === 'string' &&
        (value.includes('/Users/') || value.includes('/home/') || value.includes('\\Users\\'));

      // If sensitive, return the key with masked value
      if (hasSensitivePattern || isValueWithUserPath) {
        return [key, value ? '***' : ''];
      }

      // If not sensitive, return as is
      return [key, value];
    })
  );
};

return new Response(
  JSON.stringify(
    {
      meta: filterSensitiveVars(import.meta.env),
      process: filterSensitiveVars(process.env),
      nodeVersion: process.version,
      platform: {
        arch: process.arch,
        platform: process.platform,
        release: process.release,
        uptime: process.uptime(),
      },
      database: {
        connected: dbConnected,
      },
    },
    null,
    2
  ),
  {
    status: 200,
    headers: {
      'Content-Type': 'application/json',
    },
  }
);
---
