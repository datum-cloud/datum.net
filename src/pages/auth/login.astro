---
export const prerender = false;

import { OIDCClient } from '@libs/oidc';
import { validateAndRefreshSession } from '@libs/auth';

// Check if user is already authenticated
const { session } = await validateAndRefreshSession(Astro.cookies);

if (session) {
  // User is already logged in, redirect to intended destination or home
  const redirectTo = Astro.url.searchParams.get('redirect_uri') || '/';
  return Astro.redirect(redirectTo);
}

// Generate authorization URL with PKCE
const oidcClient = new OIDCClient();
const { authUrl, codeVerifier, nonce } = await oidcClient.getAuthorizationUrl('login');

// Store PKCE parameters in cookies
const cookieOptions = {
  path: '/',
  sameSite: 'lax' as const,
  secure: process.env.MODE === 'production',
  httpOnly: true,
  maxAge: 600, // 10 minutes - enough time to complete auth flow
};

Astro.cookies.set('codeVerifier', codeVerifier, cookieOptions);

if (nonce) {
  Astro.cookies.set('nonce', nonce, cookieOptions);
}

// Store the redirect destination
const authRedirect = Astro.url.searchParams.get('redirect_uri');
if (authRedirect) {
  Astro.cookies.set('redirect_uri', authRedirect, cookieOptions);
}

// Redirect to authorization server
return Astro.redirect(authUrl);
---
