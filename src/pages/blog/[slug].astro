---
// src/pages/blog/[slug].astro
export const prerender = false;

import '@v1/styles/page-blog.css';
import Layout from '@layouts/Layout.astro';
import Hero from '@components/Hero.astro';
import Footer from '@components/Footer.astro';
import Button from '@components/Button.astro';
import Icon from '@components/Icon.astro';
import ArticleNavigation from '@components/ArticleNavigation.astro';
import { Breadcrumbs } from 'astro-breadcrumbs';
import {
  getStrapiMediaUrl,
  resolveMarkdownStrapiUrls,
  fetchStrapiArticles,
  fetchStrapiArticleBySlug,
} from '@libs/strapi';
import type { StrapiArticle, StrapiBlock } from '@libs/strapi';
import { formatShortDate, estimateReadingTime } from '@utils/dateUtils';
import { getAuthorBgColorFromStrapi } from '@utils/authorUtils';
import defaultOgImage from '@content/images/og/blog.png';
import { marked } from 'marked';
import { truncateByWords } from '@libs/string';
import { transformMarkdownFigures } from '@utils/markdownFigure';

const { slug } = Astro.params;

// Fetch article detail (per-slug cache)
const article = await fetchStrapiArticleBySlug(slug as string);
if (!article) {
  return Astro.redirect('/404');
}

// Extract article data
const fm = {
  title: article.title,
  description: article.description,
  date: article.originalPublishedAt,
  featuredImage: article.cover
    ? getStrapiMediaUrl(article.cover.formats?.large?.url) || getStrapiMediaUrl(article.cover.url)
    : undefined,
  author: article.author?.name,
};

const formattedDate = fm.date ? formatShortDate(fm.date) : '';
const readingTime = estimateReadingTime(
  article.blocks?.map((b: StrapiBlock) => b.body).join('\n') || ''
);

// Get author data
const authorName = article.author?.name || '';
const authorSlug = article.author?.slug ?? article.author?.documentId;
const authorHref = authorSlug ? `/authors/${authorSlug}/` : undefined;
const authorAvatar = article.author?.avatar
  ? getStrapiMediaUrl(article.author.avatar.url)
  : undefined;
const authorBgColor = authorName ? await getAuthorBgColorFromStrapi(authorName) : undefined;

// Get category data
const categoryName = article.category?.name || '';
const categorySlug = article.category?.slug || '';

// Get all articles for navigation
const allArticles: StrapiArticle[] = await fetchStrapiArticles();

// Sort by publication date (newest first)
allArticles.sort((a, b) => {
  const dateA = a.originalPublishedAt ? new Date(a.originalPublishedAt).getTime() : 0;
  const dateB = b.originalPublishedAt ? new Date(b.originalPublishedAt).getTime() : 0;
  return dateB - dateA;
});

const currentIndex = allArticles.findIndex((a) => a.slug === article.slug);
const previousArticle = currentIndex > 0 ? allArticles[currentIndex - 1] : undefined;
const nextArticle =
  currentIndex < allArticles.length - 1 ? allArticles[currentIndex + 1] : undefined;

// Create breadcrumbs
const breadcrumbData = [
  { text: 'Home', href: '/' },
  { text: 'Blog', href: '/blog/' },
];

if (categorySlug) {
  breadcrumbData.push({
    text: categoryName,
    href: `/blog/category/${categorySlug}/`,
  });
}

breadcrumbData.push({
  text: truncateByWords(fm.title, 9),
  href: `/blog/${slug}/`,
});

// SEO: build meta from Strapi seo, same pattern as blog/[slug].astro
const title = article.seo?.metaTitle ?? fm.title;
const description = article.seo?.metaDescription ?? fm.description ?? '';

const blogMeta = {
  title: article.seo?.metaTitle ?? fm.title,
  description: article.seo?.metaDescription ?? fm.description ?? '',
  og: {
    image: defaultOgImage,
    title: article.seo?.ogTitle ?? fm.title,
    description: article.seo?.ogDescription ?? fm.description ?? '',
  },
};

if (article.seo?.shareImage?.url) {
  const shareImageUrl = getStrapiMediaUrl(article.seo.shareImage.url);
  if (shareImageUrl) {
    blogMeta.og.image = { src: shareImageUrl } as import('astro').ImageMetadata;
  }
}
---

<Layout
  title={title}
  description={description}
  image={fm.featuredImage}
  article={true}
  publishDate={fm.date}
  author={fm.author}
  bodyClass={`page-blog page-blog--strapi-${slug}`}
  meta={blogMeta}
>
  <section class="datum-container">
    <Hero class="light" hideContent={true} />

    <section class="bg-glacier-mist-700 section--block pt-6 md:pt-10 xl:pt-16">
      <div class="max-width blog-detail max-w-256.5">
        <aside class="blog-aside">
          <div class="blog-aside-content sticky top-0">
            <Button
              class="btn btn--alpha btn--fluid mb-11"
              text="Back to Blog"
              icon={{ name: 'arrow-left', size: 'md' }}
              iconPosition="left"
              iconClass="stroke-1.5"
              href="/blog/"
            />

            <!-- Author Information -->
            {
              authorName && (
                <div class="blog-article-author">
                  <div class="blog-article-author-avatar">
                    {authorAvatar ? (
                      <a href={authorHref ?? '#'} class="blog-article-author-image">
                        <img
                          src={authorAvatar}
                          alt={authorName}
                          class="h-full w-full object-cover"
                          style={authorBgColor ? `background-color: ${authorBgColor}` : undefined}
                        />
                      </a>
                    ) : (
                      <a
                        href={authorHref ?? '#'}
                        class="blog-article-author-image"
                        style={authorBgColor ? `background-color: ${authorBgColor}` : undefined}
                      >
                        <span class="text-lg font-bold text-gray-600">{authorName.charAt(0)}</span>
                      </a>
                    )}
                  </div>
                  <a href={authorHref ?? '#'} class="blog-article-author-name">
                    {authorName}
                  </a>
                </div>
              )
            }

            <span class="icon-label">
              <div class="icon-bg">
                <Icon name="clock" size="sm" />
              </div>
              <span class="icon-label-text">{readingTime.text}</span>
            </span>

            <span class="icon-label">
              <div class="icon-bg">
                <Icon name="calendar" size="sm" />
              </div>
              <span class="icon-label-text">{formattedDate}</span>
            </span>

            <span class="icon-label">
              <div class="icon-bg">
                <Icon name="copy" size="sm" />
              </div>
              <span class="icon-label-text">
                <button
                  type="button"
                  class="border-b hover:cursor-pointer"
                  x-data="{ copied: false }"
                  @click={`navigator.clipboard.writeText('${Astro.url.href}').then(() => { copied = true; setTimeout(() => { copied = false; }, 2000); })`}
                  x-text="copied ? 'Copied!' : 'Copy URL'"></button>
              </span>
            </span>
          </div>
        </aside>

        <article class="blog-article">
          <!-- Hidden meta tags for Pagefind -->
          <span class="hidden" style="display: none;">post</span>
          <span class="hidden" style="display: none;">{authorName}</span>
          <span class="hidden" style="display: none;">{categoryName}</span>

          <!-- Article Header -->
          <header class="blog-article-header">
            <div class="blog-article-breadcrumbs">
              <Breadcrumbs
                linkTextFormat="sentence"
                mainBemClass="a-breadcrumbs"
                crumbs={breadcrumbData.length > 0 ? breadcrumbData : undefined}
              >
                <svg
                  slot="index"
                  aria-label="Home Page"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"> </path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
              </Breadcrumbs>
            </div>
            <h1 class="blog-article-title">
              {fm.title}
            </h1>
            <div class="datum-text-sm mt-4 flex gap-1 opacity-60 md:hidden">
              <a href={authorHref ?? '#'} class="blog-article-author-name">{authorName},</a>
              <span class="blog-article-meta-date">{readingTime.text}, </span>
              <span class="blog-article-meta-date">{formattedDate}, </span>
              <button
                type="button"
                class="blog-article-meta-share"
                x-data="{ copied: false }"
                @click={`navigator.clipboard.writeText('${Astro.url.href}').then(() => { copied = true; setTimeout(() => { copied = false; }, 2000); })`}
                x-text="copied ? 'Copied!' : 'Copy URL'"></button>
            </div>
          </header>

          <!-- Featured Image -->
          {
            fm.featuredImage && (
              <div class="blog-article-image">
                <img
                  src={fm.featuredImage}
                  alt={article.cover?.alternativeText || fm.title}
                  class="fade-in--pure"
                  data-reveal="fade-in--pure--visible"
                  data-reveal-delay="100"
                />
              </div>
            )
          }

          <!-- Article Content -->
          <div class="blog-article-content">
            {
              article.blocks?.map((block: StrapiBlock) => {
                if (block.__typename === 'ComponentSharedQuote' && block.title) {
                  const bodyMarkdown = block.body ? resolveMarkdownStrapiUrls(block.body) : '';
                  const bodyHtml = bodyMarkdown ? marked(bodyMarkdown) : '';
                  return (
                    <blockquote class="blog-article-quote">
                      {block.title && <h3>{block.title}</h3>}
                      {block.body && <p set:html={bodyHtml} />}
                    </blockquote>
                  );
                }
                if (block.__typename === 'ComponentSharedRichText' && block.body) {
                  const bodyMarkdown = resolveMarkdownStrapiUrls(block.body);
                  const bodyWithFigures = transformMarkdownFigures(bodyMarkdown);
                  const bodyHtml = marked(bodyWithFigures);
                  return <div set:html={bodyHtml} />;
                }
                return null;
              })
            }
          </div>

          <!-- Article Navigation -->
          <ArticleNavigation
            previousArticle={previousArticle
              ? {
                  id: previousArticle.slug,
                  title: previousArticle.title,
                  url: `/blog/${previousArticle.slug}/`,
                  navLabel: 'Next article',
                }
              : undefined}
            nextArticle={nextArticle
              ? {
                  id: nextArticle.slug,
                  title: nextArticle.title,
                  url: `/blog/${nextArticle.slug}/`,
                  navLabel: 'Previous article',
                }
              : undefined}
          />
        </article>
      </div>

      <Footer />
    </section>
  </section>
</Layout>
