---
// src/pages/blog/category/[slug]/[page].astro
export const prerender = false;

import '@v1/styles/page-blog.css';
import Layout from '@layouts/Layout.astro';
import Hero from '@components/Hero.astro';
import Footer from '@components/Footer.astro';
import { graphql, ARTICLES_BY_CATEGORY_QUERY } from '@libs/strapi';
import type { StrapiArticlesResponse, StrapiArticle } from '@libs/strapi';
import { normalizeArticle } from '@/src/types/strapi';
import BlogItemStrapi from '@components/blog/BlogItemStrapi.astro';
import BlogPagination from '@components/blog/BlogPagination.astro';
import config from '@data/siteConfig.json';

const { slug, page: pageParam } = Astro.params;
const currentPage = parseInt((pageParam as string) ?? '1', 10);

// Fetch all articles for this category
const response = await graphql<StrapiArticlesResponse>(ARTICLES_BY_CATEGORY_QUERY, {
  categorySlug: slug,
});

// Extract articles
const rawArticles: StrapiArticle[] = response?.articles || [];

// Get category name from first article (all have same category)
const categoryName = rawArticles[0]?.category?.name || (slug as string);

if (rawArticles.length === 0) {
  return Astro.redirect('/404');
}

// Sort by publication date (newest first)
rawArticles.sort((a: StrapiArticle, b: StrapiArticle) => {
  const dateA = a.originalPublishedAt ? new Date(a.originalPublishedAt).getTime() : 0;
  const dateB = b.originalPublishedAt ? new Date(b.originalPublishedAt).getTime() : 0;
  return dateB - dateA;
});

// Normalize articles
const posts = rawArticles.map(normalizeArticle);

// Set up pagination
const pageSize = config.pageSize;
const totalItems = posts.length;
const totalPages = Math.ceil(totalItems / pageSize);
const start = (currentPage - 1) * pageSize;
const end = start + pageSize;
const currentPageData = posts.slice(start, end);

// Pagination setup
const baseUrl = `/blog/category/${slug}`;
const prevUrl = currentPage > 2 ? `${baseUrl}/${currentPage - 1}` : baseUrl;
const nextUrl = currentPage < totalPages ? `${baseUrl}/${currentPage + 1}` : undefined;

const icon = 'book-image';

// SEO
const title = categoryName;
const description = `Articles about ${categoryName} from Datum Blog`;
const subtitle = 'Blog';
---

<Layout
  title={title}
  description={description}
  bodyClass={`page-blog page-blog--strapi-${slug} page-blog--page-${currentPage}`}
  meta={{}}
>
  <section class="datum-container">
    <Hero class="light" iconName={icon} title={title} subtitle={subtitle} />

    <div class="section--block section--block--pad bg-midnight-fjord dark">
      <div class="max-width relative">
        <!-- Hidden meta tag to identify this as a category page -->
        <span data-pagefind-meta="page_type" style="display: none;">category</span>

        <!-- Blog List -->
        <div class="blog-list">
          {currentPageData.map((post) => <BlogItemStrapi post={post} baseUrl="/blog" />)}
        </div>

        <!-- Pagination -->
        <BlogPagination
          currentPage={currentPage}
          totalPages={totalPages}
          baseUrl={baseUrl}
          prevUrl={prevUrl}
          nextUrl={nextUrl}
        />
      </div>
    </div>

    <Footer />
  </section>
</Layout>
