---
// src/pages/blog/index.astro
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import config from "../../data/siteConfig.json";

// Get all published blog posts and sort them by date (newest first)
const allPosts = await getCollection("blog", ({ data }) => {
  return !data.draft && new Date(data.date) <= new Date();
});

const sortedPosts = allPosts.sort((a, b) => {
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

// Set up pagination variables for the first page
const pageSize = config.pageSize;
const currentPage = 1;
const totalItems = sortedPosts.length;
const totalPages = Math.ceil(totalItems / pageSize);
const currentPageData = sortedPosts.slice(0, pageSize);
---

<Layout title="Blog | Datum Inc. Site" description="Latest articles and insights from our team">
  <div class="mx-auto max-w-7xl">
    <div class="mb-8 rounded-lg bg-white p-8 shadow-sm">
      <h1 class="mb-6 font-heading text-4xl font-bold">Blog</h1>
      <p class="mb-8 text-gray-600">Latest articles, tutorials, and insights from our team.</p>

      <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
        {
          currentPageData.map((post) => (
            <article class="overflow-hidden rounded-lg bg-white shadow-sm transition hover:shadow-md">
              {post.data.thumbnail && (
                <a href={`/blog/${post.slug}`} class="block aspect-video overflow-hidden">
                  <Image
                    src={post.data.thumbnail}
                    alt={post.data.title}
                    class="h-full w-full object-cover transition hover:scale-105"
                    widths={[400, 600, 800]}
                    sizes="(max-width: 640px) 400px, (max-width: 1024px) 600px, 800px"
                  />
                </a>
              )}
              <div class="p-6">
                <div class="mb-2 flex items-center text-sm text-gray-500">
                  <time datetime={post.data.date.toISOString()}>
                    {new Date(post.data.date).toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                    })}
                  </time>
                </div>
                <h2 class="mb-2 line-clamp-2 font-heading text-xl font-bold">
                  <a href={`/blog/${post.slug}`} class="hover:text-primary">
                    {post.data.title}
                  </a>
                </h2>
                <p class="mb-4 line-clamp-3 text-gray-600">{post.data.description}</p>
                <a
                  href={`/blog/${post.slug}`}
                  class="inline-flex items-center font-medium text-primary hover:underline"
                >
                  Read More
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="ml-1 h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    />
                  </svg>
                </a>
              </div>
            </article>
          ))
        }
      </div>

      {
        totalPages > 1 && (
          <div class="mt-12 flex justify-center space-x-2">
            {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => (
              <a
                href={pageNum === 1 ? `/blog` : `/blog/${pageNum}`}
                class={`rounded px-4 py-2 transition ${
                  pageNum === currentPage
                    ? "bg-primary text-white"
                    : "bg-gray-100 hover:bg-gray-200"
                }`}
                aria-label={`Page ${pageNum}`}
                aria-current={pageNum === currentPage ? "page" : undefined}
              >
                {pageNum}
              </a>
            ))}

            {currentPage < totalPages && (
              <a
                href={`/blog/2`}
                class="rounded bg-gray-100 px-4 py-2 transition hover:bg-gray-200"
                aria-label="Next page"
              >
                &rarr;
              </a>
            )}
          </div>
        )
      }
    </div>
  </div>
</Layout>
