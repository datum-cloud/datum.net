---
import '@v1/styles/page-huddle.css';
import Layout from '@layouts/Layout.astro';
import Hero from '@components/Hero.astro';
import Footer from '@components/Footer.astro';
import Icon from '@components/Icon.astro';
import UpcomingHuddle from '@components/huddles/UpcomingHuddle.astro';
import PreviousHuddle from '@components/huddles/PreviousHuddle.astro';
import { getCollectionEntry } from '@utils/collectionUtils';
import { getCollection } from 'astro:content';
import type { IconName } from '@utils/iconMap';

const page = await getCollectionEntry('pages', 'community-huddle');

// Get the upcoming huddle (closest future date with publish status)
const huddles = await getCollection('huddles');
const today = new Date();
today.setHours(0, 0, 0, 0);

// Filter huddles that are published and have date >= today
const upcomingHuddles = huddles
  .filter((huddle) => {
    const huddleDate = new Date(huddle.data.date);
    huddleDate.setHours(0, 0, 0, 0);
    return huddle.data.draft == false && huddleDate >= today;
  })
  .sort((a, b) => {
    // Sort by date (closest first)
    return new Date(a.data.date).getTime() - new Date(b.data.date).getTime();
  });

const upcomingHuddle = upcomingHuddles.length > 0 ? upcomingHuddles[0] : null;

// Get previous huddles (past dates with publish status)
const previousHuddles = huddles
  .filter((huddle) => {
    const huddleDate = new Date(huddle.data.date);
    huddleDate.setHours(0, 0, 0, 0);
    return huddle.data.draft == false && huddleDate < today;
  })
  .sort((a, b) => {
    // Sort by date (most recent first)
    return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
  });

// SEO
const fm = page.data;
const meta = fm.meta || {};
const title = fm.title;
const description = fm.description ? fm.description : '';
const subtitle = fm.subtitle;
---

<Layout title={title} description={description} bodyClass="page-huddle" meta={meta}>
  <section class="datum-container">
    <Hero
      class="light [&_.hero--main-content-inner]:pb-15"
      iconName={fm.iconName}
      title={title}
      subtitle={subtitle}
    />
    <section class="section--block bg-glacier-mist-700 pb-10 md:pb-16 xl:pb-20">
      <div class="bg-glacier-mist-700 max-width">
        <div
          class="huddle-info-grid fade-in--small"
          data-reveal="fade-in--small--visible"
          data-reveal-delay="200"
        >
          {
            fm.pageInfo?.map((info: { icon: IconName; text: string }) => (
              <div class="huddle-info-card">
                <div class="huddle-info-icon">
                  <Icon name={info.icon} size="xl" class="text-pine-forge" />
                </div>
                <p class="huddle-info-text" set:html={info.text.replace(/\n/g, '<br />')} />
              </div>
            ))
          }
        </div>
      </div>
    </section>
    {
      upcomingHuddle && (
        <div class="section--block section--block--pad bg-midnight-fjord">
          <div
            class="fade-in--pure max-width"
            data-reveal="fade-in--pure--visible"
            data-reveal-immediate="true"
            data-reveal-delay="100"
          >
            <UpcomingHuddle huddle={upcomingHuddle} />
          </div>
        </div>
      )
    }

    <!-- start Previous Huddles -->
    {
      previousHuddles.length > 0 && (
        <div class="section--block section--block--pad bg-glacier-mist-700">
          <div
            class="fade-in--pure max-width"
            data-reveal="fade-in--pure--visible"
            data-reveal-delay="100"
          >
            <div class="text-midnight-fjord m-auto flex max-w-6xl flex-col">
              <h2 class="datum-text-7xl pb-9 text-center md:pb-12 xl:pb-16">Previous Huddles</h2>

              <div
                class="previous-huddles"
                x-data="{ expandedHuddle: 0 }"
                x-init="expandedHuddle = 0"
              >
                {await Promise.all(
                  previousHuddles.map(async (huddle, index) => {
                    return <PreviousHuddle huddle={huddle} index={index} />;
                  })
                )}
              </div>
            </div>
          </div>
        </div>
      )
    }
    <!-- end Previous Huddles -->

    <Footer />
  </section>
</Layout>
