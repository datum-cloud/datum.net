---
import '@v1/styles/page-handbook.css';
import Layout from '@layouts/Layout.astro';
import Hero from '@components/Hero.astro';
import Footer from '@components/Footer.astro';
import Article from '@components/handbook/Article.astro';
import defaultOgImage from '@content/images/og/handbook.png';

import { getCollection, render } from 'astro:content';

// const currentPostIndex = handbooks.findIndex((post) => post.id == Astro.params.slug);
export async function getStaticPaths() {
  const handbooks = await getCollection('handbooks', ({ id }) => id !== 'index');

  handbooks.sort(function (a, b) {
    let aSlugSplit = a.id.split('/');
    let bSlugSplit = b.id.split('/');

    // sort by order with category
    return ('' + aSlugSplit[0] + a.data.sidebar.order).localeCompare(
      '' + bSlugSplit[0] + b.data.sidebar.order
    );
  });

  // Extract headings for each handbook entry
  const renderedEntries = await Promise.all(
    handbooks.map(async (entry) => {
      const rendered = await render(entry);
      return {
        entry,
        rendered,
        headings: rendered.headings,
      };
    })
  );

  return renderedEntries.map(({ entry, rendered, headings }) => {
    return {
      params: {
        slug: entry.id,
      },
      props: { entry, rendered, handbooks, headings },
    };
  });
}

const { slug } = Astro.params;
const { entry } = Astro.props;
const { title, description, meta } = entry.data;

// Set default handbook OG image if not specified in frontmatter
const handbookMeta = {
  ...meta,
  og: {
    image: defaultOgImage,
    ...meta?.og,
  },
};
---

<Layout
  title={title}
  description={description}
  bodyClass={`page-handbook page-handbook--${slug}`}
  meta={handbookMeta}
>
  <section class="datum-container">
    <Hero class="light bg-glacier-mist-700 border-glacier-mist-900 border-b" hideContent={true} />

    <Article articleId={slug} />

    <Footer />
  </section>
</Layout>
